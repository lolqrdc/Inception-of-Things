.PHONY: help start stop clean status test ssh logs install deploy validate restart argocd-ui port-forward clean-k3d clean-vbox

# Variables P3
VAGRANT_CMD = vagrant
VB_CMD = VBoxManage
HOST_IP = 192.168.56.110
VM_NAME = edetohS-p3
SCRIPTS_DIR = .
CONFS_DIR = ../confs
KUBECTL = ../kubectl

# Couleurs
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
PURPLE = \033[0;35m
NC = \033[0m

# Installation et dÃ©marrage P3
install:
	@echo "$(GREEN)ðŸš€ Installation de la partie 3 (K3d + ArgoCD)...$(NC)"
	@$(MAKE) clean-k3d
	@$(MAKE) clean-vbox
	@echo "$(BLUE)ðŸ“¦ Installation de K3d et ArgoCD...$(NC)"
	@chmod +x $(SCRIPTS_DIR)/*.sh
	@./install.sh
	@echo "$(GREEN)âœ… Installation P3 terminÃ©e !$(NC)"

# DÃ©marrage complet P3
start: install
	@echo "$(GREEN)ðŸŒŸ DÃ©marrage de la partie 3...$(NC)"
	@echo "$(BLUE)ðŸ”§ Configuration de l'environnement...$(NC)"
	@./setup.sh
	@echo "$(BLUE)ðŸš€ DÃ©ploiement des applications...$(NC)"
	@./deploy-apps.sh
	@echo "$(GREEN)âœ… Partie 3 dÃ©marrÃ©e avec succÃ¨s !$(NC)"
	@$(MAKE) test

# ArrÃªt P3
stop:
	@echo "$(RED)ðŸ›‘ ArrÃªt de la partie 3...$(NC)"
	@./run.sh clean 2>/dev/null || true
	@$(MAKE) clean-k3d
	@$(MAKE) clean-vbox
	@echo "$(GREEN)âœ… Partie 3 arrÃªtÃ©e et nettoyÃ©e !$(NC)"

# DÃ©ploiement des applications
deploy:
	@echo "$(BLUE)ðŸš€ DÃ©ploiement des applications P3...$(NC)"
	@./deploy-apps.sh
	@echo "$(GREEN)âœ… Applications dÃ©ployÃ©es !$(NC)"

# Test P3
test:
	@echo "$(BLUE)ðŸ§ª Test de la partie 3$(NC)"
	@echo "$(YELLOW)=== Test de K3d ===$(NC)"
	@if k3d cluster list 2>/dev/null | grep -q "iot-cluster"; then \
		echo "$(GREEN)âœ… Cluster K3d 'iot-cluster' opÃ©rationnel$(NC)"; \
	else \
		echo "$(RED)âŒ Cluster K3d 'iot-cluster' non trouvÃ©$(NC)"; \
		exit 1; \
	fi
	@echo ""
	@echo "$(YELLOW)=== Test d'ArgoCD ===$(NC)"
	@if $(KUBECTL) get pods -n argocd 2>/dev/null | grep -q "argocd-server.*Running"; then \
		echo "$(GREEN)âœ… ArgoCD installÃ© et en cours d'exÃ©cution$(NC)"; \
	else \
		echo "$(RED)âŒ ArgoCD non installÃ© ou non fonctionnel$(NC)"; \
		exit 1; \
	fi
	@echo ""
	@echo "$(YELLOW)=== Test de l'application Wil ===$(NC)"
	@if $(KUBECTL) get application -n argocd 2>/dev/null | grep -q "wil-playground"; then \
		echo "$(GREEN)âœ… Application Wil dÃ©ployÃ©e dans ArgoCD$(NC)"; \
	else \
		echo "$(RED)âŒ Application Wil non dÃ©ployÃ©e dans ArgoCD$(NC)"; \
	fi
	@if $(KUBECTL) get svc wil-playground-service -n dev >/dev/null 2>&1; then \
		echo "$(GREEN)âœ… Service wil-playground-service disponible$(NC)"; \
	else \
		echo "$(RED)âŒ Service wil-playground-service non trouvÃ©$(NC)"; \
	fi
	@echo ""
	@echo "$(YELLOW)=== Statut des pods ===$(NC)"
	@$(KUBECTL) get pods -A 2>/dev/null || echo "$(RED)âŒ Impossible de rÃ©cupÃ©rer les pods$(NC)"
	@echo ""
	@./test-app.sh 2>/dev/null || echo "$(YELLOW)âš ï¸  Test d'application non disponible$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Instructions de test ===$(NC)"
	@echo "$(BLUE)Pour tester wil-playground :$(NC)"
	@echo "1. $(YELLOW)make port-forward$(NC)  # Lance le port-forward"
	@echo "2. Dans un autre terminal : $(YELLOW)curl http://localhost:8889/$(NC)"
	@echo "3. Ou dans le navigateur : $(YELLOW)http://localhost:8889$(NC)"
	@echo ""
	@echo "$(GREEN)ðŸŽ‰ Tests P3 terminÃ©s !$(NC)"

# Validation complÃ¨te
validate:
	@echo "$(PURPLE)ðŸ” Validation complÃ¨te de la partie 3$(NC)"
	@./validate.sh
	@echo "$(GREEN)âœ… Validation terminÃ©e !$(NC)"

# Statut P3
status:
	@echo "$(BLUE)ðŸ“Š Statut de la partie 3$(NC)"
	@echo "$(YELLOW)=== Statut K3d ===$(NC)"
	@k3d cluster list 2>/dev/null || echo "$(RED)âŒ K3d non disponible$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Statut ArgoCD ===$(NC)"
	@$(KUBECTL) get pods -n argocd 2>/dev/null || echo "$(RED)âŒ ArgoCD non accessible$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Applications ArgoCD ===$(NC)"
	@$(KUBECTL) get applications -n argocd 2>/dev/null || echo "$(RED)âŒ Applications non accessibles$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Statut des namespaces ===$(NC)"
	@$(KUBECTL) get namespaces 2>/dev/null || echo "$(RED)âŒ Kubectl non accessible$(NC)"

# Port-forward pour l'application wil-playground
port-forward:
	@echo "$(GREEN)ðŸŒ Port-forward vers wil-playground...$(NC)"
	@if ! $(KUBECTL) get svc wil-playground-service -n dev >/dev/null 2>&1; then \
		echo "$(RED)âŒ Service wil-playground-service non trouvÃ© dans le namespace dev$(NC)"; \
		echo "$(YELLOW)ðŸ’¡ Lancez d'abord 'make start' pour dÃ©ployer l'application$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)ðŸŒ Application accessible sur: http://localhost:8889$(NC)"
	@echo "$(YELLOW)ðŸš€ Port-forward en cours (Ctrl+C pour arrÃªter)...$(NC)"
	@$(KUBECTL) port-forward svc/wil-playground-service -n dev 8889:8888

# AccÃ¨s ArgoCD UI
argocd-ui:
	@echo "$(GREEN)ðŸŒ AccÃ¨s Ã  ArgoCD UI$(NC)"
	@echo "$(BLUE)ðŸ’¡ URL: https://localhost:8080$(NC)"
	@echo "$(BLUE)ðŸ’¡ Username: admin$(NC)"
	@echo "$(BLUE)ðŸ’¡ Password: RÃ©cupÃ©ration du mot de passe...$(NC)"
	@./kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" 2>/dev/null | base64 -d || echo "$(RED)âŒ Impossible de rÃ©cupÃ©rer le mot de passe$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸš€ Port-forward en cours...$(NC)"
	@./kubectl port-forward svc/argocd-server -n argocd 8080:443 &
	@echo "$(GREEN)âœ… ArgoCD accessible sur https://localhost:8080$(NC)"

# Logs
logs:
	@echo "$(BLUE)ðŸ“‹ Logs de la partie 3$(NC)"
	@echo "$(YELLOW)=== Logs ArgoCD Server ===$(NC)"
	@./kubectl logs -n argocd -l app.kubernetes.io/name=argocd-server --tail=10 2>/dev/null || echo "$(RED)âŒ Pas de logs ArgoCD server$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Logs Application Wil ===$(NC)"
	@./kubectl logs -n dev -l app=wil-playground --tail=10 2>/dev/null || echo "$(RED)âŒ Pas de logs application Wil$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Logs ArgoCD Application Controller ===$(NC)"
	@./kubectl logs -n argocd -l app.kubernetes.io/name=argocd-application-controller --tail=10 2>/dev/null || echo "$(RED)âŒ Pas de logs controller$(NC)"

# RedÃ©marrage des services
restart:
	@echo "$(YELLOW)ðŸ”„ RedÃ©marrage des services P3...$(NC)"
	@./$(SCRIPTS_DIR)/run.sh restart 2>/dev/null || echo "$(YELLOW)âš ï¸  Script restart non disponible$(NC)"
	@echo "$(GREEN)âœ… Services redÃ©marrÃ©s !$(NC)"

# Nettoyage des clusters K3d rÃ©siduels
clean-k3d:
	@if command -v k3d >/dev/null 2>&1; then \
		echo "$(YELLOW)ðŸ§¹ Nettoyage des clusters K3d existants...$(NC)"; \
		k3d cluster list 2>/dev/null | grep -E "iot-cluster|wil" | awk '{print $$1}' | xargs -r k3d cluster delete 2>/dev/null || true; \
		echo "$(GREEN)âœ… Clusters K3d nettoyÃ©s$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  K3d non disponible, saut du nettoyage$(NC)"; \
	fi

# Nettoyage VirtualBox (au cas oÃ¹)
clean-vbox:
	@if command -v $(VB_CMD) >/dev/null 2>&1; then \
		if $(VB_CMD) list vms | grep -q "\"$(VM_NAME)\""; then \
			echo "$(YELLOW)âš ï¸  Suppression de la VM rÃ©siduelle $(VM_NAME)...$(NC)"; \
			$(VB_CMD) controlvm "$(VM_NAME)" poweroff 2>/dev/null || true; \
			$(VB_CMD) unregistervm "$(VM_NAME)" --delete >/dev/null 2>&1 || true; \
		fi; \
	fi

# Nettoyage complet
clean: stop clean-k3d clean-vbox
	@echo "$(GREEN)âœ… Nettoyage complet P3 terminÃ© !$(NC)"

# Aide
help:
	@echo "$(BLUE)ðŸ“– Inception of Things - Partie 3$(NC)"
	@echo ""
	@echo "$(GREEN)ðŸš€ Commandes principales :$(NC)"
	@echo "  $(YELLOW)make install$(NC)     - Installer K3d et ArgoCD"
	@echo "  $(YELLOW)make start$(NC)       - DÃ©marrage complet P3 (install + setup + deploy + test)"
	@echo "  $(YELLOW)make stop$(NC)        - ArrÃªter et nettoyer P3"
	@echo "  $(YELLOW)make deploy$(NC)      - DÃ©ployer les applications"
	@echo "  $(YELLOW)make test$(NC)        - Tester P3 (cluster + ArgoCD + apps)"
	@echo "  $(YELLOW)make validate$(NC)    - Validation complÃ¨te"
	@echo ""
	@echo "$(GREEN)ðŸ”§ Commandes utilitaires :$(NC)"
	@echo "  $(YELLOW)make status$(NC)      - Afficher le statut de P3"
	@echo "  $(YELLOW)make logs$(NC)        - Afficher les logs"
	@echo "  $(YELLOW)make restart$(NC)     - RedÃ©marrer les services"
	@echo "  $(YELLOW)make argocd-ui$(NC)   - AccÃ©der Ã  ArgoCD UI"
	@echo "  $(YELLOW)make port-forward$(NC) - Port-forward vers wil-playground"
	@echo "  $(YELLOW)make clean$(NC)       - Nettoyage complet"
	@echo ""
	@echo "$(GREEN)ðŸŽ¯ Workflow recommandÃ© :$(NC)"
	@echo "  1. $(YELLOW)make start$(NC)        # Installation + dÃ©marrage + test automatique"
	@echo "  2. $(YELLOW)make argocd-ui$(NC)    # AccÃ¨s Ã  l'interface ArgoCD"
	@echo "  3. $(YELLOW)make port-forward$(NC) # Port-forward vers wil-playground"
	@echo "  4. $(YELLOW)make validate$(NC)     # Validation complÃ¨te"
	@echo "  5. $(YELLOW)make stop$(NC)         # ArrÃªt et nettoyage"
	@echo ""
	@echo "$(GREEN)ðŸŒŸ Technologies P3 :$(NC)"
	@echo "  â€¢ K3d : Cluster Kubernetes dans Docker"
	@echo "  â€¢ ArgoCD : GitOps et dÃ©ploiement continu"
	@echo "  â€¢ Application Wil : DÃ©ployÃ©e via GitOps"
	@echo ""
	@echo "$(BLUE)ðŸ’¡ ArgoCD UI :$(NC)"
	@echo "  â€¢ URL: https://localhost:8080"
	@echo "  â€¢ Username: admin"
	@echo "  â€¢ Password: voir 'make argocd-ui'"