# -*- mode: ruby -*-
# vi: set ft=ruby :

# Part 2: K3s and three simple applications
# Specifications:
# - 1 machine avec K3s en mode server
# - Latest stable OS distribution
# - 3 applications web accessibles selon le HOST
# - IP: 192.168.56.110
# - Hostname: login + S (edetohS)
# - Ingress routing:
#   - HOST app1.com â†’ app1
#   - HOST app2.com â†’ app2 (3 replicas)
#   - Default â†’ app3

Vagrant.configure("2") do |config|
	config.vm.box = "bento/debian-13"  # Latest stable Debian
	config.ssh.insert_key = true
	config.vm.boot_timeout = 600
	config.ssh.connect_timeout = 120

	# Server P2 - edetohS
	config.vm.define "edetohS" do |server|
		server.vm.hostname = "edetohS"
		server.vm.network "private_network", ip: "192.168.56.110"
		server.vm.synced_folder "./confs", "/vagrant"

		server.vm.provider "virtualbox" do |vb|
			vb.memory = 2048  # Plus de RAM pour les 3 applications
			vb.cpus = 2
			vb.name = "edetohS-p2"
		end

		server.vm.provision "shell", inline: <<-SHELL
			echo "ðŸš€ Configuration du serveur K3s P2..."

			# Installation K3s en mode server
			curl -sfL https://get.k3s.io | sh -s - server --flannel-iface=eth1

			# Attendre que K3s soit prÃªt
			while [ ! -f /var/lib/rancher/k3s/server/node-token ]; do sleep 2; done

			# Copier la configuration pour l'accÃ¨s externe
			sudo cp /etc/rancher/k3s/k3s.yaml /vagrant/k3s.yaml
			sudo chown vagrant:vagrant /vagrant/k3s.yaml

			echo "â³ Attente que K3s soit complÃ¨tement prÃªt..."
			sleep 30

			echo "ðŸ“¦ DÃ©ploiement des applications..."

			# DÃ©ploiement de app1
			if [ -f /vagrant/app1-deployment.yaml ]; then
				sudo k3s kubectl apply -f /vagrant/app1-deployment.yaml
				echo "âœ… App1 dÃ©ployÃ©e"
			fi

			# DÃ©ploiement de app2 (3 replicas)
			if [ -f /vagrant/app2-deployment.yaml ]; then
				sudo k3s kubectl apply -f /vagrant/app2-deployment.yaml
				echo "âœ… App2 dÃ©ployÃ©e (3 replicas)"
			fi

			# DÃ©ploiement de app3 (default)
			if [ -f /vagrant/app3-deployment.yaml ]; then
				sudo k3s kubectl apply -f /vagrant/app3-deployment.yaml
				echo "âœ… App3 dÃ©ployÃ©e (default)"
			fi

			# Configuration de l'Ingress
			if [ -f /vagrant/ingress.yaml ]; then
				sudo k3s kubectl apply -f /vagrant/ingress.yaml
				echo "âœ… Ingress configurÃ©"
			fi

			echo "â³ Attente du dÃ©ploiement des pods..."
			sleep 20

			echo "ðŸ” Statut du cluster:"
			sudo k3s kubectl get nodes
			echo ""
			echo "ðŸ” Statut des pods:"
			sudo k3s kubectl get pods -o wide
			echo ""
			echo "ðŸ” Statut des services:"
			sudo k3s kubectl get services
			echo ""
			echo "ðŸ” Statut de l'ingress:"
			sudo k3s kubectl get ingress
			echo ""

			echo "âœ… Configuration P2 terminÃ©e!"
			echo "ðŸŒ AccÃ¨s aux applications:"
			echo "  â€¢ app1.com â†’ http://192.168.56.110 (avec HOST: app1.com)"
			echo "  â€¢ app2.com â†’ http://192.168.56.110 (avec HOST: app2.com)"
			echo "  â€¢ default  â†’ http://192.168.56.110 (accÃ¨s direct)"
			echo ""
			echo "ðŸ’¡ Pour tester, ajoutez Ã  votre /etc/hosts:"
			echo "192.168.56.110 app1.com app2.com"
		SHELL
	end
end