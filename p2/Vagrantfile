Vagrant.configure("2") do |config|
	# Configuration SSH simplifi√©e
	config.ssh.insert_key = false
	config.vm.boot_timeout = 600

	# Configuration globale VirtualBox pour virtualisation imbriqu√©e
	config.vm.provider "virtualbox" do |vb|
		vb.customize ["modifyvm", :id, "--nested-hw-virt", "on"]
		vb.customize ["modifyvm", :id, "--paravirtprovider", "none"]
		vb.customize ["modifyvm", :id, "--hwvirtex", "on"]
		vb.customize ["modifyvm", :id, "--nestedpaging", "on"]
	end

	# Master Node - edetohS
	config.vm.define "edetohS" do |master|
		master.vm.box = "ubuntu/bionic64"
		master.vm.network "private_network", ip: "192.168.56.110"
		master.vm.hostname = "edetohS"
		master.vm.synced_folder "./confs", "/vagrant"

		master.vm.provider "virtualbox" do |vb|
			vb.memory = "2048"  # Augment√© pour plus de stabilit√©
			vb.cpus = "2"
			vb.name = "k3s-master"
		end

		master.vm.provision "shell", inline: <<-SHELL
		echo "üöÄ Configuration du master K3s..."

		# Mise √† jour syst√®me
		apt-get update >/dev/null 2>&1
		apt-get install -y curl wget net-tools >/dev/null 2>&1

		# Configuration r√©seau
		tee /etc/netplan/01-netcfg.yaml > /dev/null <<EOF
network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s8:
      addresses: [192.168.56.110/24]
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
EOF
		netplan apply >/dev/null 2>&1
		sleep 3

		# Installation K3s master
		echo "üì¶ Installation de K3s..."
		curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE="644" INSTALL_K3S_EXEC="--flannel-iface enp0s8" sh - >/dev/null 2>&1
		sleep 10

		# Attendre que K3s soit pr√™t
		while [ ! -f /var/lib/rancher/k3s/server/node-token ]; do
			sleep 2
		done

		# Copier les fichiers de configuration
		cp /var/lib/rancher/k3s/server/node-token /vagrant/
		cp /etc/rancher/k3s/k3s.yaml /vagrant/
		chmod 644 /vagrant/node-token /vagrant/k3s.yaml

		echo "‚úÖ Master K3s configur√© avec succ√®s"
		echo "üìù Le d√©ploiement de l'application se fera apr√®s la connexion du worker"
		SHELL
	end

	# Worker Node - edetohSW
	config.vm.define "edetohSW", autostart: true do |worker|
		worker.vm.box = "ubuntu/bionic64"
		worker.vm.hostname = "edetohSW"
		worker.vm.network "private_network", ip: "192.168.56.111"
		worker.vm.synced_folder "./confs", "/vagrant"

		worker.vm.provider "virtualbox" do |vb|
			vb.memory = "1536"
			vb.cpus = "1"
			vb.name = "k3s-worker"
		end

		worker.vm.provision "shell", inline: <<-SHELL
		echo "üîó Configuration du worker K3s..."

		# Mise √† jour syst√®me
		apt-get update >/dev/null 2>&1
		apt-get install -y curl wget netcat >/dev/null 2>&1

		# Configuration r√©seau
		tee /etc/netplan/01-netcfg.yaml > /dev/null <<EOF
network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s8:
      addresses: [192.168.56.111/24]
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
EOF
		netplan apply >/dev/null 2>&1
		sleep 3

		# Attendre la connectivit√© avec le master
		echo "‚è≥ Attente de la connectivit√© avec le master..."
		while ! nc -z 192.168.56.110 6443 2>/dev/null; do
			sleep 3
		done

		# Attendre le token
		while [ ! -f /vagrant/node-token ]; do
			sleep 2
		done

		# Installation K3s worker
		echo "üì¶ Installation de K3s agent..."
		TOKEN=$(cat /vagrant/node-token | tr -d '\r\n')
		curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE="644" INSTALL_K3S_EXEC="--flannel-iface enp0s8" K3S_URL="https://192.168.56.110:6443" K3S_TOKEN="$TOKEN" sh - >/dev/null 2>&1

		# Attendre que le service k3s-agent soit d√©marr√©
		echo "‚è≥ Attente du d√©marrage du service k3s-agent..."
		sleep 15

		# V√©rifier que le service est actif
		while ! systemctl is-active --quiet k3s-agent; do
			echo "   Service k3s-agent en cours de d√©marrage..."
			sleep 5
		done
		echo "‚úÖ Service k3s-agent d√©marr√©"

		# D√©ployer l'application depuis le worker apr√®s qu'il soit connect√©
		echo "üì¶ D√©ploiement de l'application sur le worker..."

		# Remplacer l'IP localhost par l'IP du master dans kubeconfig
		sed -i 's/127.0.0.1/192.168.56.110/g' /vagrant/k3s.yaml

		# Attendre que le cluster soit compl√®tement pr√™t
		echo "‚è≥ V√©rification de l'√©tat du cluster..."
		timeout=180
		cluster_ready=false

		while [ $timeout -gt 0 ]; do
			# V√©rifier que kubectl fonctionne
			if KUBECONFIG=/vagrant/k3s.yaml kubectl get nodes >/dev/null 2>&1; then
				# V√©rifier que les deux n≈ìuds sont Ready
				ready_nodes=$(KUBECONFIG=/vagrant/k3s.yaml kubectl get nodes --no-headers | grep -c "Ready")
				if [ "$ready_nodes" -eq 2 ]; then
					echo "‚úÖ Cluster pr√™t avec les deux n≈ìuds"
					cluster_ready=true
					break
				else
					echo "   N≈ìuds pr√™ts: $ready_nodes/2"
				fi
			else
				echo "   kubectl non accessible, attente..."
			fi
			sleep 10
			timeout=$((timeout-10))
		done

		if [ "$cluster_ready" = true ]; then
			echo "üì¶ Application de la configuration app1-deployment.yaml..."
			KUBECONFIG=/vagrant/k3s.yaml kubectl apply -f /vagrant/app1-deployment.yaml

			echo "‚è≥ Attente du d√©ploiement app1..."
			KUBECONFIG=/vagrant/k3s.yaml kubectl rollout status deployment/app1-deployment --timeout=60s

			echo "üì¶ Application de la configuration app2-deployment.yaml..."
			KUBECONFIG=/vagrant/k3s.yaml kubectl apply -f /vagrant/app2-deployment.yaml

			echo "‚è≥ Attente du d√©ploiement app2..."
			KUBECONFIG=/vagrant/k3s.yaml kubectl rollout status deployment/app2-deployment --timeout=60s

			echo "üì¶ Application de la configuration app3-deployment.yaml..."
			KUBECONFIG=/vagrant/k3s.yaml kubectl apply -f /vagrant/app3-deployment.yaml

			echo "‚è≥ Attente du d√©ploiement app3..."
			KUBECONFIG=/vagrant/k3s.yaml kubectl rollout status deployment/app3-deployment --timeout=60s

			echo "ÔøΩ Configuration de l'Ingress..."
			KUBECONFIG=/vagrant/k3s.yaml kubectl apply -f /vagrant/ingress.yaml

			echo "ÔøΩüìä √âtat final du cluster:"
			KUBECONFIG=/vagrant/k3s.yaml kubectl get nodes -o wide
			echo "üìä √âtat des pods:"
			KUBECONFIG=/vagrant/k3s.yaml kubectl get pods -o wide
			echo "üìä √âtat des services:"
			KUBECONFIG=/vagrant/k3s.yaml kubectl get services
			echo "üìä √âtat des Ingress:"
			KUBECONFIG=/vagrant/k3s.yaml kubectl get ingress
		else
			echo "‚ö†Ô∏è  Timeout: Impossible de d√©ployer, cluster non pr√™t apr√®s 3 minutes"
			echo "üìä √âtat actuel des n≈ìuds:"
			KUBECONFIG=/vagrant/k3s.yaml kubectl get nodes 2>/dev/null || echo "kubectl non accessible"
		fi

		echo "‚úÖ Worker K3s configur√© avec succ√®s"
		SHELL
	end
end