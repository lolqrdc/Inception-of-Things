.PHONY: help start stop clean status test ssh logs

# Variables P2
VAGRANT_CMD = vagrant
VB_CMD = VBoxManage
HOST_IP = 192.168.56.110
VM_NAME = edetohS-p2
VAGRANTFILE_DIR = ..

# Couleurs
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m

# DÃ©marrage P2
start:
	@echo "$(GREEN)ğŸš€ DÃ©marrage de la partie 2 (K3s + 3 applications)...$(NC)"
	@$(MAKE) clean-vbox
	@echo "$(BLUE)ğŸ“¦ DÃ©marrage du serveur P2...$(NC)"
	@cd $(VAGRANTFILE_DIR) && $(VAGRANT_CMD) up
	@echo "$(GREEN)âœ… Partie 2 dÃ©marrÃ©e avec succÃ¨s !$(NC)"
	@$(MAKE) test

# ArrÃªt P2
stop:
	@echo "$(RED)ğŸ›‘ ArrÃªt de la partie 2...$(NC)"
	@cd $(VAGRANTFILE_DIR) && $(VAGRANT_CMD) destroy -f || true
	@$(MAKE) clean-vbox
	@cd $(VAGRANTFILE_DIR) && rm -f k3s.yaml
	@cd $(VAGRANTFILE_DIR) && rm -rf .vagrant
	@echo "$(GREEN)âœ… Partie 2 arrÃªtÃ©e et nettoyÃ©e !$(NC)"

# Test P2
test:
	@echo "$(BLUE)ğŸ§ª Test de la partie 2$(NC)"
	@echo "$(YELLOW)=== Test de connectivitÃ© K3s ===$(NC)"
	@if cd $(VAGRANTFILE_DIR) && $(VAGRANT_CMD) ssh -c "sudo k3s kubectl get nodes" 2>/dev/null | grep -q "Ready"; then \
		echo "$(GREEN)âœ… Serveur K3s opÃ©rationnel$(NC)"; \
	else \
		echo "$(RED)âŒ Serveur K3s non fonctionnel$(NC)"; \
		exit 1; \
	fi
	@echo ""
	@echo "$(YELLOW)=== Test des applications ===$(NC)"
	@cd $(VAGRANTFILE_DIR) && $(VAGRANT_CMD) ssh -c "sudo k3s kubectl get pods -o wide" 2>/dev/null || echo "$(RED)âŒ Impossible de rÃ©cupÃ©rer les pods$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Test des services ===$(NC)"
	@cd $(VAGRANTFILE_DIR) && $(VAGRANT_CMD) ssh -c "sudo k3s kubectl get services" 2>/dev/null || echo "$(RED)âŒ Impossible de rÃ©cupÃ©rer les services$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Test de l'ingress ===$(NC)"
	@cd $(VAGRANTFILE_DIR) && $(VAGRANT_CMD) ssh -c "sudo k3s kubectl get ingress" 2>/dev/null || echo "$(RED)âŒ Impossible de rÃ©cupÃ©rer l'ingress$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Instructions de test ===$(NC)"
	@echo "$(BLUE)Pour tester les applications, ajoutez Ã  votre /etc/hosts :$(NC)"
	@echo "$(HOST_IP) app1.com app2.com"
	@echo ""
	@echo "$(BLUE)Puis testez :$(NC)"
	@echo "â€¢ curl -H \"Host: app1.com\" http://$(HOST_IP)"
	@echo "â€¢ curl -H \"Host: app2.com\" http://$(HOST_IP)"
	@echo "â€¢ curl http://$(HOST_IP)  # app3 par dÃ©faut"
	@echo ""
	@echo "$(GREEN)ğŸ‰ Tests P2 terminÃ©s !$(NC)"

# Statut P2
status:
	@echo "$(BLUE)ğŸ“Š Statut de la partie 2$(NC)"
	@echo "$(YELLOW)=== Statut de la VM ===$(NC)"
	@$(VAGRANT_CMD) status
	@echo ""
	@if $(VAGRANT_CMD) status | grep -q "running"; then \
		echo "$(YELLOW)=== Statut du cluster K3s ===$(NC)"; \
		$(VAGRANT_CMD) ssh -c "sudo k3s kubectl get nodes -o wide" 2>/dev/null || echo "$(RED)âŒ K3s non accessible$(NC)"; \
		echo ""; \
		echo "$(YELLOW)=== Statut des applications ===$(NC)"; \
		$(VAGRANT_CMD) ssh -c "sudo k3s kubectl get pods,services,ingress" 2>/dev/null || echo "$(RED)âŒ Applications non accessibles$(NC)"; \
	fi

# SSH vers le serveur
ssh:
	@echo "$(GREEN)ğŸ”‘ Connexion SSH vers le serveur P2...$(NC)"
	@$(VAGRANT_CMD) ssh

# Logs des applications
logs:
	@echo "$(BLUE)ğŸ“‹ Logs des applications P2$(NC)"
	@echo "$(YELLOW)=== Logs app1 ===$(NC)"
	@$(VAGRANT_CMD) ssh -c "sudo k3s kubectl logs -l app=app1 --tail=10" 2>/dev/null || echo "$(RED)âŒ Pas de logs app1$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Logs app2 ===$(NC)"
	@$(VAGRANT_CMD) ssh -c "sudo k3s kubectl logs -l app=app2 --tail=10" 2>/dev/null || echo "$(RED)âŒ Pas de logs app2$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Logs app3 ===$(NC)"
	@$(VAGRANT_CMD) ssh -c "sudo k3s kubectl logs -l app=app3 --tail=10" 2>/dev/null || echo "$(RED)âŒ Pas de logs app3$(NC)"

# Nettoyage des VMs VirtualBox rÃ©siduelles
clean-vbox:
	@if command -v $(VB_CMD) >/dev/null 2>&1; then \
		if $(VB_CMD) list vms | grep -q "\"$(VM_NAME)\""; then \
			echo "$(YELLOW)âš ï¸  Suppression de la VM rÃ©siduelle $(VM_NAME)...$(NC)"; \
			$(VB_CMD) controlvm "$(VM_NAME)" poweroff 2>/dev/null || true; \
			$(VB_CMD) unregistervm "$(VM_NAME)" --delete >/dev/null 2>&1 || true; \
		fi; \
	else \
		echo "$(YELLOW)âš ï¸  VBoxManage non disponible, saut du nettoyage VirtualBox$(NC)"; \
	fi

# Nettoyage complet
clean: stop

# Aide
help:
	@echo "$(BLUE)ğŸ“– Inception of Things - Partie 2$(NC)"
	@echo ""
	@echo "$(GREEN)ğŸš€ Commandes disponibles :$(NC)"
	@echo "  $(YELLOW)make start$(NC)    - DÃ©marrer P2 (K3s + 3 applications)"
	@echo "  $(YELLOW)make stop$(NC)     - ArrÃªter et nettoyer P2"
	@echo "  $(YELLOW)make test$(NC)     - Tester P2 (cluster + applications)"
	@echo "  $(YELLOW)make status$(NC)   - Afficher le statut de P2"
	@echo "  $(YELLOW)make ssh$(NC)      - Se connecter en SSH au serveur"
	@echo "  $(YELLOW)make logs$(NC)     - Afficher les logs des applications"
	@echo "  $(YELLOW)make clean$(NC)    - Nettoyage complet (= stop)"
	@echo ""
	@echo "$(GREEN)ğŸ¯ Workflow recommandÃ© :$(NC)"
	@echo "  1. $(YELLOW)make start$(NC)   # DÃ©marre P2 + test automatique"
	@echo "  2. $(YELLOW)make test$(NC)    # Tests supplÃ©mentaires si besoin"
	@echo "  3. $(YELLOW)make stop$(NC)    # ArrÃªt et nettoyage"
	@echo ""
	@echo "$(GREEN)ğŸŒ Applications P2 :$(NC)"
	@echo "  â€¢ Serveur unique : $(HOST_IP)"
	@echo "  â€¢ app1.com â†’ app1"
	@echo "  â€¢ app2.com â†’ app2 (3 replicas)"
	@echo "  â€¢ default  â†’ app3"
	@echo ""
	@echo "$(BLUE)ğŸ’¡ Configuration /etc/hosts :$(NC)"
	@echo "  $(HOST_IP) app1.com app2.com"