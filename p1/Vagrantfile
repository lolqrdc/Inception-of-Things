# -*- mode: ruby -*-
# vi: set ft=ruby :

# Part 1: K3s and Vagrant
# Specifications:
# - 2 machines avec ressources minimales (1 CPU, 512-1024 MB RAM)
# - Latest stable OS distribution
# - SSH sans mot de passe
# - IPs dédiées sur eth1: 192.168.56.110 (Server), 192.168.56.111 (ServerWorker)
# - K3s controller sur Server, K3s agent sur ServerWorker

Vagrant.configure("2") do |config|
	config.vm.box = "bento/debian-13"  # Latest stable Debian
	config.ssh.insert_key = true
	config.vm.boot_timeout = 600  # 10 minutes
	config.ssh.connect_timeout = 120  # 2 minutes

	# Server (Master) - edetohS
	config.vm.define "edetohS" do |server|
		server.vm.hostname = "edetohS"
		server.vm.network "private_network", ip: "192.168.56.110"

		server.vm.provider "virtualbox" do |vb|
			vb.memory = 1024  # Ressources minimales
			vb.cpus = 1
			vb.name = "edetohS"
		end

		server.vm.provision "shell", inline: <<-SHELL
			# Installation K3s en mode controller
			curl -sfL https://get.k3s.io | sh -s - server --flannel-iface=eth1

			# Attendre que K3s soit prêt
			while [ ! -f /var/lib/rancher/k3s/server/node-token ]; do sleep 2; done

			# Copier le token pour le worker
			sudo cp /var/lib/rancher/k3s/server/node-token /vagrant/node-token 2>/dev/null || true
			sudo cp /etc/rancher/k3s/k3s.yaml /vagrant/k3s.yaml 2>/dev/null || true
			sudo chmod 644 /vagrant/node-token /vagrant/k3s.yaml 2>/dev/null || true

			echo "✅ K3s server configuré"
		SHELL
	end

	# ServerWorker (Agent) - edetohSW
	config.vm.define "edetohSW", autostart: false do |worker|
		worker.vm.hostname = "edetohSW"
		worker.vm.network "private_network", ip: "192.168.56.111"

		worker.vm.provider "virtualbox" do |vb|
			vb.memory = 512   # Ressources minimales
			vb.cpus = 1
			vb.name = "edetohSW"
		end

		worker.vm.provision "shell", inline: <<-SHELL
			# Installation netcat pour les tests de connectivité
			apt-get update -qq && apt-get install -y netcat-openbsd

			# Attendre que le server soit prêt
			while ! nc -z 192.168.56.110 6443 2>/dev/null; do
				echo "Attente du server K3s..."
				sleep 3
			done

			# Attendre le token
			while [ ! -f /vagrant/node-token ]; do
				echo "Attente du token..."
				sleep 3
			done

			# Installation K3s en mode agent
			TOKEN=$(cat /vagrant/node-token)
			curl -sfL https://get.k3s.io | K3S_TOKEN="$TOKEN" sh -s - agent \
				--server=https://192.168.56.110:6443 --flannel-iface=eth1

			echo "✅ K3s agent configuré"
		SHELL
	end
end