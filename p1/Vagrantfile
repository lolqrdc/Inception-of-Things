Vagrant.configure("2") do |config|
	# Configuration SSH simplifi√©e
	config.ssh.insert_key = false
	config.vm.boot_timeout = 600

	# Configuration globale VirtualBox pour virtualisation imbriqu√©e
	config.vm.provider "virtualbox" do |vb|
		vb.customize ["modifyvm", :id, "--nested-hw-virt", "on"]
		vb.customize ["modifyvm", :id, "--paravirtprovider", "none"]
		vb.customize ["modifyvm", :id, "--hwvirtex", "on"]
		vb.customize ["modifyvm", :id, "--nestedpaging", "on"]
	end

	# Master Node - edetohS
	config.vm.define "edetohS" do |master|
		master.vm.box = "phz/noble64"
		master.vm.network "private_network", ip: "192.168.56.110"
		master.vm.hostname = "edetohS"
		master.vm.synced_folder "./confs", "/vagrant"

		master.vm.provider "virtualbox" do |vb|
			vb.memory = "2048"  # Augment√© pour plus de stabilit√©
			vb.cpus = "2"
			vb.name = "k3s-master"
		end

		master.vm.provision "shell", inline: <<-SHELL
		echo "üöÄ Configuration du master K3s..."

		# Mise √† jour syst√®me
		apt-get update >/dev/null 2>&1
		apt-get install -y curl wget net-tools >/dev/null 2>&1

		# Configuration r√©seau
		tee /etc/netplan/01-netcfg.yaml > /dev/null <<EOF
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses: [192.168.56.110/24]
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
EOF
		netplan apply >/dev/null 2>&1
		sleep 3

		# Installation K3s master
		echo "üì¶ Installation de K3s..."
		curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE="644" INSTALL_K3S_EXEC="--flannel-iface eth1" sh - >/dev/null 2>&1
		sleep 10

		# Attendre que K3s soit pr√™t
		while [ ! -f /var/lib/rancher/k3s/server/node-token ]; do
			sleep 2
		done

		# Copier les fichiers de configuration
		cp /var/lib/rancher/k3s/server/node-token /vagrant/
		cp /etc/rancher/k3s/k3s.yaml /vagrant/
		chmod 644 /vagrant/node-token /vagrant/k3s.yaml

		echo "‚úÖ Master K3s configur√© avec succ√®s"
		SHELL
	end

	# Worker Node - edetohSW
	config.vm.define "edetohSW", autostart: false do |worker|
		worker.vm.box = "phz/noble64"
		worker.vm.hostname = "edetohSW"
		worker.vm.network "private_network", ip: "192.168.56.111"
		worker.vm.synced_folder "./confs", "/vagrant"

		worker.vm.provider "virtualbox" do |vb|
			vb.memory = "1536"
			vb.cpus = "1"
			vb.name = "k3s-worker"
		end

		worker.vm.provision "shell", inline: <<-SHELL
		echo "üîó Configuration du worker K3s..."

		# Mise √† jour syst√®me
		apt-get update >/dev/null 2>&1
		apt-get install -y curl wget netcat >/dev/null 2>&1

		# Configuration r√©seau
		tee /etc/netplan/01-netcfg.yaml > /dev/null <<EOF
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses: [192.168.56.111/24]
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
EOF
		netplan apply >/dev/null 2>&1
		sleep 3

		# Attendre la connectivit√© avec le master
		echo "‚è≥ Attente de la connectivit√© avec le master..."
		while ! nc -z 192.168.56.110 6443 2>/dev/null; do
			sleep 3
		done

		# Attendre le token
		while [ ! -f /vagrant/node-token ]; do
			sleep 2
		done

		# Installation K3s worker
		echo "üì¶ Installation de K3s agent..."
		TOKEN=$(cat /vagrant/node-token | tr -d '\r\n')
		curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE="644" INSTALL_K3S_EXEC="--flannel-iface eth1" K3S_URL="https://192.168.56.110:6443" K3S_TOKEN="$TOKEN" sh - >/dev/null 2>&1

		echo "‚úÖ Worker K3s configur√© avec succ√®s"
		SHELL
	end
end