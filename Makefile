.PHONY: all up clean destroy re status ssh-server ssh-worker logs help fix-box cluster-info get-kubeconfig restart-k3s test-automation cleanup-orphans deploy

# Variables
VAGRANT_CMD = vagrant
PROJECT_NAME = p1-vagrant

# Couleurs pour l'affichage
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

# Target par d√©faut
all: up

# Lancer les machines virtuelles
up:
	@echo "$(GREEN)üöÄ D√©marrage du cluster K3s automatique...$(NC)"
	@echo "$(BLUE)üßπ V√©rification et nettoyage pr√©alable...$(NC)"
	@$(MAKE) -s cleanup-orphans || true
	@echo "$(BLUE)üìÅ Cr√©ation du dossier confs si n√©cessaire...$(NC)"
	@mkdir -p confs
	@chmod 755 confs
	@echo "$(BLUE)üîß V√©rification que le script d'automatisation est ex√©cutable...$(NC)"
	@chmod +x scripts/fetch_k3s_files.sh
	@echo "$(BLUE)‚ö° Lancement des VMs avec Vagrant (100% automatique)...$(NC)"
	$(VAGRANT_CMD) up
	@echo "$(GREEN)‚úÖ Cluster K3s d√©ploy√© automatiquement avec succ√®s !$(NC)"
	@echo "$(YELLOW)üìã V√©rification de l'√©tat du cluster...$(NC)"
	@sleep 5
	@$(MAKE) cluster-info
	@echo "$(GREEN)üéâ D√©ploiement 100% automatique termin√© !$(NC)"

# Nettoyer et red√©marrer compl√®tement
re: clean up

# Alternative √† 're'
remake: re

# Nettoyer compl√®tement (destruction des VMs et nettoyage des ressources)
clean:
	@echo "$(RED)üßπ Nettoyage complet du projet...$(NC)"
	@echo "$(YELLOW)üõë Arr√™t et destruction des VMs...$(NC)"
	-$(VAGRANT_CMD) destroy -f
	@$(MAKE) -s cleanup-orphans
	@echo "$(YELLOW)üìÅ Nettoyage des fichiers temporaires...$(NC)"
	-rm -f confs/node-token*
	-rm -f confs/k3s.yaml*
	-rm -rf .vagrant
	@echo "$(GREEN)‚úÖ Nettoyage complet termin√© !$(NC)"

# Nettoyage des domaines orphelins (commande interne)
cleanup-orphans:
	@echo "$(YELLOW)üóëÔ∏è  Suppression des domaines libvirt orphelins...$(NC)"
	-sudo virsh destroy $(PROJECT_NAME)_edetohS 2>/dev/null || true
	-sudo virsh destroy $(PROJECT_NAME)_edetohSW 2>/dev/null || true
	-sudo virsh destroy $(PROJECT_NAME)_agloriosS 2>/dev/null || true
	-sudo virsh destroy $(PROJECT_NAME)_agloriosSW 2>/dev/null || true
	-sudo virsh undefine $(PROJECT_NAME)_edetohS --remove-all-storage 2>/dev/null || true
	-sudo virsh undefine $(PROJECT_NAME)_edetohSW --remove-all-storage 2>/dev/null || true
	-sudo virsh undefine $(PROJECT_NAME)_agloriosS --remove-all-storage 2>/dev/null || true
	-sudo virsh undefine $(PROJECT_NAME)_agloriosSW --remove-all-storage 2>/dev/null || true
	@echo "$(YELLOW)üßπ Nettoyage des volumes orphelins...$(NC)"
	-sudo virsh vol-delete $(PROJECT_NAME)_edetohS.img default 2>/dev/null || true
	-sudo virsh vol-delete $(PROJECT_NAME)_edetohSW.img default 2>/dev/null || true
	-sudo virsh vol-delete $(PROJECT_NAME)_agloriosS.img default 2>/dev/null || true
	-sudo virsh vol-delete $(PROJECT_NAME)_agloriosSW.img default 2>/dev/null || true

# Destruction des VMs seulement
destroy:
	@echo "$(RED)üõë Destruction des machines virtuelles...$(NC)"
	$(VAGRANT_CMD) destroy -f
	@echo "$(GREEN)‚úÖ Machines d√©truites !$(NC)"

# Afficher le statut des machines
status:
	@echo "$(BLUE)üìä Statut des machines Vagrant :$(NC)"
	$(VAGRANT_CMD) status
	@echo ""
	@echo "$(BLUE)üìä Statut des domaines libvirt :$(NC)"
	@sudo virsh list --all | grep -E "(edetohS|edetohSW)" || echo "Aucun domaine trouv√©"

# SSH vers le serveur
ssh-server:
	@echo "$(GREEN)üîë Connexion SSH vers le serveur (edetohS)...$(NC)"
	$(VAGRANT_CMD) ssh edetohS

# SSH vers le worker
ssh-worker:
	@echo "$(GREEN)üîë Connexion SSH vers le worker (edetohSW)...$(NC)"
	$(VAGRANT_CMD) ssh edetohSW

# Afficher les logs des machines
logs:
	@echo "$(BLUE)üìù Logs de la derni√®re ex√©cution :$(NC)"
	@echo "$(YELLOW)=== Logs du serveur (edetohS) ===$(NC)"
	-$(VAGRANT_CMD) ssh edetohS -c "sudo journalctl -u k3s --no-pager -n 20" 2>/dev/null || echo "Pas de logs disponibles"
	@echo ""
	@echo "$(YELLOW)=== Logs du worker (edetohSW) ===$(NC)"
	-$(VAGRANT_CMD) ssh edetohSW -c "sudo journalctl -u k3s-agent --no-pager -n 20" 2>/dev/null || echo "Pas de logs disponibles"

# V√©rifier l'√©tat du cluster K3s
cluster-info:
	@echo "$(BLUE)üîç Informations sur le cluster K3s :$(NC)"
	@echo "$(YELLOW)=== N≈ìuds du cluster ===$(NC)"
	-$(VAGRANT_CMD) ssh edetohS -c "sudo k3s kubectl get nodes -o wide" 2>/dev/null || echo "$(RED)‚ùå Cluster non accessible$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Pods syst√®me ===$(NC)"
	-$(VAGRANT_CMD) ssh edetohS -c "sudo k3s kubectl get pods -A" 2>/dev/null || echo "$(RED)‚ùå Impossible de r√©cup√©rer les pods$(NC)"
	@echo ""
	@echo "$(YELLOW)=== Fichiers d'automatisation ===$(NC)"
	@if [ -f confs/node-token ] && [ -f confs/k3s.yaml ]; then \
		echo "$(GREEN)‚úÖ Token et configuration K3s pr√©sents$(NC)"; \
		echo "$(BLUE)üìÑ Token: $$(wc -c < confs/node-token) bytes$(NC)"; \
		echo "$(BLUE)üìÑ Config: $$(wc -c < confs/k3s.yaml) bytes$(NC)"; \
	else \
		echo "$(RED)‚ùå Fichiers de configuration manquants$(NC)"; \
	fi

# Copier la configuration kubectl vers l'h√¥te
get-kubeconfig:
	@echo "$(BLUE)üìã R√©cup√©ration de la configuration kubectl...$(NC)"
	@mkdir -p ~/.kube
	@if [ -f confs/k3s.yaml ]; then \
		cp confs/k3s.yaml ~/.kube/config-p1; \
		sed -i 's/127.0.0.1/192.168.56.110/g' ~/.kube/config-p1; \
		chmod 600 ~/.kube/config-p1; \
		echo "$(GREEN)‚úÖ Configuration copi√©e vers ~/.kube/config-p1$(NC)"; \
		echo "$(YELLOW)üí° Utilisez: export KUBECONFIG=~/.kube/config-p1$(NC)"; \
	else \
		echo "$(RED)‚ùå Fichier k3s.yaml non trouv√© dans confs/$(NC)"; \
	fi

# Red√©marrer les services K3s
restart-k3s:
	@echo "$(YELLOW)üîÑ Red√©marrage des services K3s...$(NC)"
	-$(VAGRANT_CMD) ssh edetohS -c "sudo rc-service k3s restart"
	-$(VAGRANT_CMD) ssh edetohSW -c "sudo rc-service k3s-agent restart"
	@echo "$(GREEN)‚úÖ Services red√©marr√©s !$(NC)"

# Tester l'automatisation compl√®te
test-automation:
	@echo "$(BLUE)üß™ Test de l'automatisation 100% automatique...$(NC)"
	@echo "$(YELLOW)‚ö†Ô∏è  Ce test va d√©truire et recr√©er compl√®tement le cluster !$(NC)"
	@read -p "Continuer ? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@$(MAKE) clean
	@echo "$(BLUE)‚è≥ Attente de 3 secondes...$(NC)"
	@sleep 3
	@$(MAKE) up
	@echo "$(GREEN)üéâ Test d'automatisation termin√© avec succ√®s !$(NC)"

# Surveillance en temps r√©el du cluster
monitor:
	@echo "$(BLUE)üëÄ Surveillance en temps r√©el du cluster K3s...$(NC)"
	@echo "$(YELLOW)Appuyez sur Ctrl+C pour arr√™ter$(NC)"
	@echo ""
	@while true; do \
		clear; \
		echo "$(GREEN)=== CLUSTER K3S - $$(date) ===$(NC)"; \
		echo ""; \
		$(MAKE) cluster-info 2>/dev/null; \
		echo ""; \
		echo "$(BLUE)Rafra√Æchissement dans 10 secondes...$(NC)"; \
		sleep 10; \
	done

# Validation rapide du cluster
validate:
	@echo "$(BLUE)‚úÖ Validation rapide du cluster...$(NC)"
	@echo "$(YELLOW)=== Test de connectivit√© ===$(NC)"
	@$(VAGRANT_CMD) ssh edetohS -c "ping -c 3 192.168.56.111" >/dev/null 2>&1 && echo "$(GREEN)‚úÖ Connectivit√© master ‚Üí worker OK$(NC)" || echo "$(RED)‚ùå Probl√®me de connectivit√©$(NC)"
	@echo "$(YELLOW)=== Test des services K3s ===$(NC)"
	@$(VAGRANT_CMD) ssh edetohS -c "sudo rc-service k3s status" >/dev/null 2>&1 && echo "$(GREEN)‚úÖ Service K3s master OK$(NC)" || echo "$(RED)‚ùå Service K3s master en √©chec$(NC)"
	@$(VAGRANT_CMD) ssh edetohSW -c "sudo rc-service k3s-agent status" >/dev/null 2>&1 && echo "$(GREEN)‚úÖ Service K3s worker OK$(NC)" || echo "$(RED)‚ùå Service K3s worker en √©chec$(NC)"
	@echo "$(YELLOW)=== Test des n≈ìuds ===$(NC)"
	@if $(VAGRANT_CMD) ssh edetohS -c "sudo k3s kubectl get nodes --no-headers 2>/dev/null | grep -c Ready" 2>/dev/null | grep -q "2"; then \
		echo "$(GREEN)‚úÖ Cluster avec 2 n≈ìuds op√©rationnels$(NC)"; \
	else \
		echo "$(RED)‚ùå Cluster incomplet ou n≈ìuds non pr√™ts$(NC)"; \
	fi

# D√©ploiement complet automatis√© (alternative qui force la r√©cup√©ration des fichiers)
deploy:
	@echo "$(GREEN)üöÄ D√©ploiement complet du cluster K3s...$(NC)"
	@$(MAKE) up
	@echo "$(BLUE)üì• R√©cup√©ration automatique des fichiers...$(NC)"
	@sleep 15
	@./scripts/fetch_k3s_files.sh
	@echo "$(BLUE)üîß D√©ploiement du worker node...$(NC)"
	@$(VAGRANT_CMD) up edetohSW
	@echo "$(GREEN)üéâ Validation finale...$(NC)"
	@$(MAKE) validate
	@echo "$(GREEN)‚úÖ Cluster K3s compl√®tement d√©ploy√© !$(NC)"

# Afficher l'aide
help:
	@echo "$(BLUE)üìñ Aide - Makefile pour le cluster K3s$(NC)"
	@echo ""
	@echo "$(GREEN)Commandes principales :$(NC)"
	@echo "  $(YELLOW)make$(NC) ou $(YELLOW)make up$(NC)     - Cr√©er et d√©marrer le master K3s"
	@echo "  $(YELLOW)make deploy$(NC)         - D√©ploiement complet automatis√© (master + worker)"
	@echo "  $(YELLOW)make re$(NC)             - Nettoyer et red√©marrer compl√®tement"
	@echo "  $(YELLOW)make clean$(NC)          - Nettoyer compl√®tement (VMs + ressources)"
	@echo "  $(YELLOW)make destroy$(NC)        - D√©truire seulement les VMs"
	@echo ""
	@echo "$(GREEN)Commandes d'information :$(NC)"
	@echo "  $(YELLOW)make status$(NC)         - Afficher le statut des machines"
	@echo "  $(YELLOW)make cluster-info$(NC)   - Informations sur le cluster K3s"
	@echo "  $(YELLOW)make logs$(NC)           - Afficher les logs des services"
	@echo "  $(YELLOW)make validate$(NC)       - Validation rapide du cluster"
	@echo ""
	@echo "$(GREEN)Commandes de connexion :$(NC)"
	@echo "  $(YELLOW)make ssh-server$(NC)     - SSH vers le serveur K3s"
	@echo "  $(YELLOW)make ssh-worker$(NC)     - SSH vers le worker K3s"
	@echo ""
	@echo "$(GREEN)Commandes avanc√©es :$(NC)"
	@echo "  $(YELLOW)make get-kubeconfig$(NC) - Copier la config kubectl vers l'h√¥te"
	@echo "  $(YELLOW)make restart-k3s$(NC)    - Red√©marrer les services K3s"
	@echo "  $(YELLOW)make test-automation$(NC) - Tester l'automatisation compl√®te"
	@echo "  $(YELLOW)make monitor$(NC)        - Surveillance en temps r√©el du cluster"
	@echo "  $(YELLOW)make fix-box$(NC)        - R√©parer les probl√®mes de box Vagrant"
	@echo "  $(YELLOW)make help$(NC)           - Afficher cette aide"
	@echo ""
	@echo "$(BLUE)üöÄ D√©marrage rapide: $(YELLOW)make deploy$(NC) pour un cluster complet en une commande$(NC)"
	@echo "$(BLUE)üí° Astuce: Apr√®s 'make deploy', utilisez 'make get-kubeconfig' pour acc√©der au cluster depuis l'h√¥te$(NC)"

# R√©parer les probl√®mes de box Vagrant corrompue
fix-box:
	@echo "$(RED)üîß R√©paration des probl√®mes de box Vagrant...$(NC)"
	@echo "$(YELLOW)üõë Nettoyage des m√©tadonn√©es Vagrant...$(NC)"
	-sudo rm -rf .vagrant
	@echo "$(YELLOW)üóëÔ∏è  Suppression de la box Alpine corrompue...$(NC)"
	-vagrant box remove generic/alpine312 --force
	@echo "$(YELLOW)üßπ Nettoyage des volumes libvirt orphelins...$(NC)"
	-sudo virsh vol-delete generic-VAGRANTSLASH-alpine312_vagrant_box_image_4.3.12_box.img default 2>/dev/null || true
	@echo "$(YELLOW)üì¶ Ret√©l√©chargement de la box Alpine...$(NC)"
	vagrant box add generic/alpine312 --provider libvirt
	@echo "$(GREEN)‚úÖ R√©paration termin√©e ! Vous pouvez maintenant utiliser 'make up'$(NC)"
